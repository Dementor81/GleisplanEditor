<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="Cache-control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <link rel="shortcut icon" type="image/ico" href="favicon.ico" />
    <title>Gleisplan</title>
    <link rel="stylesheet" href="start.css">
    <!--     <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
    <script src="https://code.createjs.com/1.0.0/createjs.min.js"></script> -->

    <link rel="stylesheet" href="dev/bootstrap-5.2.2/bootstrap-icons.css">
    <link href="dev/bootstrap-5.2.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="dev/bootstrap-5.2.2/js/bootstrap.bundle.min.js"></script>
    <script src="dev/jquery-3.6.1.js"></script>
    <script src="dev/createjs.js"></script>

    <script src="code/preLoader.js"></script>
    <script src="code/signaling.js"></script>

    <script src="tools.js"></script>
    <script src="code/track.js?02"></script>


    <style type="text/css">

    </style>
    <script>

        'use strict';

        $(() => { init(); });

        function showPopup(r, content, parent) {
            let $dummy = $("#dummy");
            let rect = parent[0].getBoundingClientRect();
            if ($dummy.length == 0) {

                $dummy = $("<div>", { id: "dummy", width: r.width, height: r.height });
                $(document.body).append($dummy)
            }
            $dummy.css({ position: "absolute", left: r.x + rect.x, top: r.y + rect.y });
            let popup = bootstrap.Popover.getOrCreateInstance($dummy);
            if (popup) {
                $(document).off("mouseup");
                popup.dispose();
            }

            let random = Math.random();

            popup = new bootstrap.Popover($dummy, {
                html: true,
                trigger: "manual",
                title: "test",
                placement: "right",
                sanitize: false,
                content: $("<div>", { id: "popup" }).html(content)
            });
            $dummy[0].addEventListener('hidden.bs.popover', (e) => {
                $(document).off("mouseup");
                let p = bootstrap.Popover.getOrCreateInstance(e.target)
                if (p) p.dispose();
                $(e.target).remove();

            }, { once: true });
            $dummy[0].addEventListener('shown.bs.popover', (e) => {
                $(document).on("mouseup", (event) => {
                    let $target = $(event.target);
                    console.log(event);
                    if ($target.closest('div.popover').length == 0) {
                        let p = bootstrap.Popover.getOrCreateInstance(e.target)
                        if (p)
                            p.hide();
                    }
                })

            }, { once: true });
            popup.show();
        }

        function showContextMenu(point, parent, items) {
            const createDropDownItems = function (items) {
                return items.map(item => {
                    const li = $("<li>");
                    const a = $("<a>", { class: "dropdown-item", href: "#" }).text(item.text);
                    if (item.childs) {
                        li.addClass("dropend");
                        a.addClass("dropdown-toggle submenu");
                        a.attr("type", "button");
                        a.attr("data-bs-toggle", "dropdown");
                        a.append($("<ul>", { class: "dropdown-menu dropdown-menu-end" }).append(createDropDownItems(item.childs)));
                    }
                    li.append(a);
                    return li;
                });
            }

            let a = $("<a>", { class: "visually-hidden" })
                .attr("data-bs-toggle", "dropdown")
                .attr("data-bs-auto-close", "false");
            let div = $("<div>", { id: "generated_menu", class: "dropdown" }).append([a,
                $("<ul>", { class: "dropdown-menu" }).append(createDropDownItems(items))
            ]);
            $(document.body).append(div);
            const dropdownList = bootstrap.Dropdown.getOrCreateInstance(a);
            
            setTimeout(() => dropdownList._config.autoClose = "outside", 2);
            dropdownList._parent.addEventListener('hidden.bs.dropdown', (e) => {
                const t = $(e.target);
                if (!t.hasClass("submenu"))
                    $(e.target).parent().remove();
            });
            let $dummy = $(dropdownList._parent);
            let rect = parent[0].getBoundingClientRect();

            $dummy.css({ position: "absolute", left: point.x + rect.x, top: point.y + rect.y });
            dropdownList.show();
        }

        /* function createDropDownItems(items) {
            return items.map(item => {
                const li = $("<li>");
                const a = $("<a>", { class: "dropdown-item", href: "#" }).text(item.text);
                if (item.childs) {
                    li.addClass("dropend");
                    a.addClass("dropdown-toggle submenu");
                    a.attr("type", "button");
                    a.attr("data-bs-toggle", "dropdown");
                    a.append($("<ul>", { class: "dropdown-menu dropdown-menu-end" }).append(createDropDownItems(item.childs)));
                }
                li.append(a);
                return li;
            });
        } */


        function init() {
            /* $(thing).click((e) => {
                showPopup({ x: e.offsetX, y: e.offsetY, width: 10, height: 10 }, $("<h6>", { class: "dropdown-header" }).text("Signal"), $("#thing"));

            }) */
            //createDropDown()
            $(thing).on("mousedown", e => {
                e.stopPropagation();

            })
            $(thing).on("mouseup", e => {
                e.stopPropagation();
                showContextMenu({ x: e.offsetX, y: e.offsetY, width: 10, height: 10 }, $(thing), [{ text: "test1" }, { text: "test2" }, { text: "test3", childs: [{ text: "test4" }] }]);
            })
            /* $(thing).click((e) => {
                //if (!$("#generated_menu").length) {

                //}
            }) */

            thing.oncontextmenu = function () {
                return false;
            };


        }




    </script>
</head>

<body>



    <div id="thing" style="position: absolute; top: 50px;left: 100px; width: 500px; height: 500px;margin-left: 83px;"
        class="bg-secondary rounded" draggable="false"></div>

    <div class="dropdown" style="position: absolute; left: 50px; top:50px;">
        <a class="" data-bs-auto-close="outside" id="dropdownMenuLink" data-bs-toggle="dropdown"> test</a>

        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#">Action</a></li>
            <li><a class="dropdown-item" href="#">Another action</a></li>
            <li><a class="dropdown-item" href="#">Something else here</a></li>
            <li class="dropend">
                <a class="dropdown-item dropdown-toggle" type="button" data-bs-toggle="dropdown">untermen√º </a>
                <ul class="dropdown-menu  dropdown-menu-end">
                    <li><a class="dropdown-item" href="#">Action</a></li>
                    <li><a class="dropdown-item" href="#">Another action</a></li>
                    <li><a class="dropdown-item" href="#">Something else here</a></li>
                </ul>
            </li>
        </ul>
    </div>


</body>

</html>